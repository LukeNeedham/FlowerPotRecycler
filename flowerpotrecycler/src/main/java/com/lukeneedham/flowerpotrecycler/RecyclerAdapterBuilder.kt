package com.lukeneedham.flowerpotrecycler

import android.content.Context
import android.view.View
import android.view.ViewGroup
import androidx.annotation.LayoutRes
import com.lukeneedham.flowerpotrecycler.autoadapter.AutoGeneratedRecyclerAdapter
import com.lukeneedham.flowerpotrecycler.autoadapter.AutoGeneratedRecyclerItemView
import com.lukeneedham.flowerpotrecycler.autoadapter.builderbinder.XMLBuilderBinder
import com.lukeneedham.flowerpotrecycler.autoadapter.builderbinder.declarative.DeclarativeBindingDsl
import com.lukeneedham.flowerpotrecycler.autoadapter.builderbinder.declarative.DeclarativeBuilderBinder
import com.lukeneedham.flowerpotrecycler.delegatedadapter.DelegatedRecyclerAdapter
import com.lukeneedham.flowerpotrecycler.delegatedadapter.RecyclerItemView
import com.lukeneedham.flowerpotrecycler.delegatedadapter.config.LinearAdapterConfig
import com.lukeneedham.flowerpotrecycler.delegatedadapter.config.RecyclerAdapterConfig

object RecyclerAdapterBuilder {

    /**
     * Auto-generate an adapter.
     * To be used when creating the item View programmatically (for example, with Anko DSL Layouts)
     *
     * Use [onItem][com.lukeneedham.flowerpotrecycler.autoadapter.builderbinder.declarative.DeclarativeBindingDsl.onItem]
     * within your builder to update the UI when an item is bound.
     * @param builder The callback for building item Views
     * @param config Optional configuration for the adapter
     */
    fun <ItemType> fromDeclarativeDsl(
        builder: DeclarativeBindingDsl<ItemType>.(ViewGroup) -> View,
        config: RecyclerAdapterConfig<ItemType, AutoGeneratedRecyclerItemView<ItemType>> = getDefaultAdapterConfig()
    ): AutoGeneratedRecyclerAdapter<ItemType> {
        val builderBinder = object : DeclarativeBuilderBinder<ItemType>() {
            override val builder = builder
        }
        return AutoGeneratedRecyclerAdapter(builderBinder, config)
    }

    /**
     * Auto-generate an adapter.
     * To be used when creating the item View programmatically (for example, with Anko DSL Layouts)
     *
     * Use [onItem][com.lukeneedham.flowerpotrecycler.autoadapter.builderbinder.declarative.DeclarativeBindingDsl.onItem]
     * within your builder to update the UI when an item is bound.
     * @param builder The callback for building item Views
     * @param configSetupBlock Optional block for setting up the adapter config
     */
    fun <ItemType> fromDeclarativeDsl(
        builder: DeclarativeBindingDsl<ItemType>.(ViewGroup) -> View,
        configSetupBlock: RecyclerAdapterConfig<ItemType, AutoGeneratedRecyclerItemView<ItemType>>.() -> Unit
    ): AutoGeneratedRecyclerAdapter<ItemType> {
        val config = getDefaultAdapterConfig<ItemType, AutoGeneratedRecyclerItemView<ItemType>>()
        configSetupBlock(config)
        return fromDeclarativeDsl(builder, config)
    }

    /**
     * Auto-generate an adapter.
     * To be used when creating the item View from inflating an XML layout.
     * @param layoutResId The XML layout resource ID to inflate to build the View
     * @param binder The callback for binding each item to its View
     * @param config Optional configuration for the adapter
     */
    fun <ItemType> fromXml(
        @LayoutRes layoutResId: Int,
        binder: (Int, ItemType, View) -> Unit,
        config: RecyclerAdapterConfig<ItemType, AutoGeneratedRecyclerItemView<ItemType>> = getDefaultAdapterConfig()
    ): AutoGeneratedRecyclerAdapter<ItemType> {
        val builderBinder = object : XMLBuilderBinder<ItemType>(layoutResId) {
            override fun bind(position: Int, item: ItemType, itemView: View) {
                binder(position, item, itemView)
            }
        }
        return AutoGeneratedRecyclerAdapter(builderBinder, config)
    }

    /**
     * Auto-generate an adapter.
     * To be used when creating the item View from inflating an XML layout.
     * @param layoutResId The XML layout resource ID to inflate to build the View
     * @param binder The callback for binding each item to its View
     * @param configSetupBlock Optional block for setting up the adapter config
     */
    fun <ItemType> fromXml(
        @LayoutRes layoutResId: Int,
        binder: (Int, ItemType, View) -> Unit,
        configSetupBlock: RecyclerAdapterConfig<ItemType, AutoGeneratedRecyclerItemView<ItemType>>.() -> Unit
    ): AutoGeneratedRecyclerAdapter<ItemType> {
        val config = getDefaultAdapterConfig<ItemType, AutoGeneratedRecyclerItemView<ItemType>>()
        configSetupBlock(config)
        return fromXml(layoutResId, binder, config)
    }

    /**
     * Setup without writing an adapter.
     * To be used when View logic is contained within its own class, and you want to instantiate the View object yourself.
     * @param createView The function to instantiate your [ItemViewType] class
     * @param config Optional configuration for the adapter
     */
    fun <ItemType, ItemViewType> fromViewCreator(
        config: RecyclerAdapterConfig<ItemType, ItemViewType> = getDefaultAdapterConfig(),
        createView: (Context) -> ItemViewType
    ): DelegatedRecyclerAdapter<ItemType, ItemViewType>
            where ItemViewType : View, ItemViewType : RecyclerItemView<ItemType> =
        object : DelegatedRecyclerAdapter<ItemType, ItemViewType>(config) {
            override fun createItemView(context: Context) = createView(context)
        }

    /**
     * Setup without writing an adapter.
     * To be used when View logic is contained within its own class, and you want to instantiate the View object yourself.
     * @param createView The function to instantiate your [ItemViewType] class
     * @param configSetupBlock Optional block for setting up the adapter config
     */
    fun <ItemType, ItemViewType> fromViewCreator(
        configSetupBlock: RecyclerAdapterConfig<ItemType, ItemViewType>.() -> Unit,
        createView: (Context) -> ItemViewType
    ): DelegatedRecyclerAdapter<ItemType, ItemViewType>
            where ItemViewType : View, ItemViewType : RecyclerItemView<ItemType> {
        val config = getDefaultAdapterConfig<ItemType, ItemViewType>()
        configSetupBlock(config)
        return fromViewCreator(config, createView)
    }

    /**
     * Setup without writing an adapter.
     * To be used when View logic is contained within its own class.
     *
     * The type parameter 'ItemViewType' is the type of the View class, which will handle binding items.
     * This class is automatically instantiated using its View(Context) constructor.
     *
     * @param config Optional configuration for the adapter
     */
    inline fun <ItemType, reified ItemViewType> fromView(
        config: RecyclerAdapterConfig<ItemType, ItemViewType> = getDefaultAdapterConfig()
    ): DelegatedRecyclerAdapter<ItemType, ItemViewType>
            where ItemViewType : View, ItemViewType : RecyclerItemView<ItemType> =
        fromViewClass(ItemViewType::class.java, config)

    /**
     * Setup without writing an adapter.
     * To be used when View logic is contained within its own class.
     *
     * The type parameter 'ItemViewType' is the type of the View class, which will handle binding items.
     * This class is automatically instantiated using its View(Context) constructor.
     *
     * @param configSetupBlock Optional block for setting up the adapter config
     */
    inline fun <ItemType, reified ItemViewType> fromView(
        configSetupBlock: RecyclerAdapterConfig<ItemType, ItemViewType>.() -> Unit
    ): DelegatedRecyclerAdapter<ItemType, ItemViewType>
            where ItemViewType : View, ItemViewType : RecyclerItemView<ItemType> {
        val config = getDefaultAdapterConfig<ItemType, ItemViewType>()
        configSetupBlock(config)
        return fromView(config)
    }

    /**
     * Setup without writing an adapter.
     * To be used when View logic is contained within its own class.
     * @param itemViewClass The [ItemViewType] class which will handle binding items.
     * @param config Optional configuration for the adapter
     * This class is automatically instantiated using its View(context: Context) constructor.
     */
    @JvmStatic
    fun <ItemType, ItemViewType> fromViewClass(
        itemViewClass: Class<ItemViewType>,
        config: RecyclerAdapterConfig<ItemType, ItemViewType> = getDefaultAdapterConfig()
    ): DelegatedRecyclerAdapter<ItemType, ItemViewType>
            where ItemViewType : View, ItemViewType : RecyclerItemView<ItemType> =
        object : DelegatedRecyclerAdapter<ItemType, ItemViewType>(config) {
            override fun createItemView(context: Context) =
                itemViewClass.getConstructor(Context::class.java).newInstance(context)
        }

    /**
     * Setup without writing an adapter.
     * To be used when View logic is contained within its own class.
     * @param itemViewClass The [ItemViewType] class which will handle binding items.
     * @param configSetupBlock Optional block for setting up the adapter config
     * This class is automatically instantiated using its View(context: Context) constructor.
     */
    @JvmStatic
    fun <ItemType, ItemViewType> fromViewClass(
        itemViewClass: Class<ItemViewType>,
        configSetupBlock: RecyclerAdapterConfig<ItemType, ItemViewType>.() -> Unit
    ): DelegatedRecyclerAdapter<ItemType, ItemViewType>
            where ItemViewType : View, ItemViewType : RecyclerItemView<ItemType> {
        val config = getDefaultAdapterConfig<ItemType, ItemViewType>()
        configSetupBlock(config)
        return fromViewClass(itemViewClass, config)
    }

    fun <ItemType, ItemViewType> getDefaultAdapterConfig()
            where ItemViewType : View, ItemViewType : RecyclerItemView<ItemType> =
        LinearAdapterConfig<ItemType, ItemViewType>()
}